$(window).load(function(){game.init()});$(document).on("mobileinit",function(){jQuery.mobile.autoInitializePage=false});(function(){var e=0;var t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n){window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame)window.requestAnimationFrame=function(t,n){var r=(new Date).getTime();var i=Math.max(0,16-(r-e));var s=window.setTimeout(function(){t(r+i)},i);e=r+i;return s};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(e){clearTimeout(e)}})();var b2Vec2=Box2D.Common.Math.b2Vec2;var b2BodyDef=Box2D.Dynamics.b2BodyDef;var b2Body=Box2D.Dynamics.b2Body;var b2FixtureDef=Box2D.Dynamics.b2FixtureDef;var b2Fixture=Box2D.Dynamics.b2Fixture;var b2World=Box2D.Dynamics.b2World;var b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape;var b2CircleShape=Box2D.Collision.Shapes.b2CircleShape;var b2DebugDraw=Box2D.Dynamics.b2DebugDraw;var box2d={scale:30,init:function(){var e=new b2Vec2(0,9.8);var t=true;box2d.world=new b2World(e,t);var n=new Box2D.Dynamics.b2ContactListener;n.PostSolve=function(e,t){var n=e.GetFixtureA().GetBody();var r=e.GetFixtureB().GetBody();var i=n.GetUserData();var s=r.GetUserData();var o=Math.abs(t.normalImpulses[0]);if(o>5){if(i.health){i.health-=o}if(s.health){s.health-=o}if(i.bounceSound){i.bounceSound.play()}if(s.bounceSound){s.bounceSound.play()}}};box2d.world.SetContactListener(n)},createRectangle:function(e,t){var n=new b2BodyDef;if(e.isStatic){n.type=b2Body.b2_staticBody}else{n.type=b2Body.b2_dynamicBody}n.position.x=e.x/box2d.scale;n.position.y=e.y/box2d.scale;if(e.angle){n.angle=Math.PI*e.angle/180}var r=new b2FixtureDef;r.density=t.density;r.friction=t.friction;r.restitution=t.restitution;r.shape=new b2PolygonShape;r.shape.SetAsBox(e.width/2/box2d.scale,e.height/2/box2d.scale);var i=box2d.world.CreateBody(n);i.SetUserData(e);var s=i.CreateFixture(r);return i},createCircle:function(e,t){var n=new b2BodyDef;if(e.isStatic){n.type=b2Body.b2_staticBody}else{n.type=b2Body.b2_dynamicBody}n.position.x=e.x/box2d.scale;n.position.y=e.y/box2d.scale;if(e.angle){n.angle=Math.PI*e.angle/180}var r=new b2FixtureDef;r.density=t.density;r.friction=t.friction;r.restitution=t.restitution;r.shape=new b2CircleShape(e.radius/box2d.scale);var i=box2d.world.CreateBody(n);i.SetUserData(e);i.SetAngularDamping(3.5);var s=i.CreateFixture(r);return i},step:function(e){if(e>1/30){e=1/30}box2d.world.Step(e,8,3)}};var game={init:function(){levels.init();loader.init();mouse.init();game.backgroundMusic=loader.loadSound("audio/gurdonark-kindergarten");game.slingshotReleasedSound=loader.loadSound("audio/released");game.bounceSound=loader.loadSound("audio/bounce");game.breakSound={glass:loader.loadSound("audio/glassbreak"),wood:loader.loadSound("audio/woodbreak")};$(".gamelayer").hide();$("#gamestartscreen").show();game.canvas=$("#gamecanvas")[0];game.context=game.canvas.getContext("2d")},showLevelScreen:function(){game.stop();$(".gamelayer").hide();$("#levelselectscreen").show("slow")},mode:"intro",slingshotX:140,slingshotY:280,start:function(){$(".gamelayer").hide();$("#gamecanvas").show();$("#scorescreen").show();game.mode="intro";game.offsetLeft=0;game.ended=false;game.animationFrame=window.requestAnimationFrame(game.animate,game.canvas);game.startBackgroundMusic()},maxSpeed:3,minOffset:0,maxOffset:300,offsetLeft:0,score:0,panTo:function(e){if(Math.abs(e-game.offsetLeft-game.canvas.width/4)>0&&game.offsetLeft<=game.maxOffset&&game.offsetLeft>=game.minOffset){var t=Math.round((e-game.offsetLeft-game.canvas.width/4)/2);if(t&&Math.abs(t)>game.maxSpeed)t=game.maxSpeed*Math.abs(t)/t;game.offsetLeft+=t}else{return true}if(game.offsetLeft<game.minOffset){game.offsetLeft=game.minOffset;return true}else if(game.offsetLeft>game.maxOffset){game.offsetLeft=game.maxOffset;return true}return false},handlePanning:function(){if(game.mode=="intro"){if(game.panTo(700)){game.mode="load-next-hero"}}if(game.mode=="wait-for-firing"){if(mouse.dragging){if(game.mouseOnCurrentHero()){game.mode="firing"}else{game.panTo(mouse.x+game.offsetLeft)}}else{game.panTo(game.slingshotX)}}if(game.mode=="firing"){if(mouse.down){game.panTo(game.slingshotX);game.currentHero.SetPosition({x:(mouse.x+game.offsetLeft)/box2d.scale,y:mouse.y/box2d.scale})}else{game.mode="fired";game.slingshotReleasedSound.play();var e=.75;var t=game.slingshotX+35;var n=game.slingshotY+25;var r=new b2Vec2((t-mouse.x-game.offsetLeft)*e,(n-mouse.y)*e);game.currentHero.ApplyImpulse(r,game.currentHero.GetWorldCenter())}}if(game.mode=="fired"){var i=game.currentHero.GetPosition().x*box2d.scale;game.panTo(i);if(!game.currentHero.IsAwake()||i<0||i>game.currentLevel.foregroundImage.width){box2d.world.DestroyBody(game.currentHero);game.currentHero=undefined;game.mode="load-next-hero"}}if(game.mode=="load-next-hero"){game.countHeroesAndVillains();if(game.villains.length==0){game.mode="level-success";return}if(game.heroes.length==0){game.mode="level-failure";return}if(!game.currentHero){game.currentHero=game.heroes[game.heroes.length-1];game.currentHero.SetPosition({x:180/box2d.scale,y:200/box2d.scale});game.currentHero.SetLinearVelocity({x:0,y:0});game.currentHero.SetAngularVelocity(0);game.currentHero.SetAwake(true)}else{game.panTo(game.slingshotX);if(!game.currentHero.IsAwake()){game.mode="wait-for-firing"}}}if(game.mode=="level-success"||game.mode=="level-failure"){if(game.panTo(0)){game.ended=true;game.showEndingScreen()}}},countHeroesAndVillains:function(){game.heroes=[];game.villains=[];for(var e=box2d.world.GetBodyList();e;e=e.GetNext()){var t=e.GetUserData();if(t){if(t.type=="hero"){game.heroes.push(e)}else if(t.type=="villain"){game.villains.push(e)}}}},animate:function(){game.handlePanning();var e=(new Date).getTime();var t;if(game.lastUpdateTime){t=(e-game.lastUpdateTime)/1e3;box2d.step(t)}game.lastUpdateTime=e;game.context.drawImage(game.currentLevel.backgroundImage,game.offsetLeft/4,0,640,480,0,0,640,480);game.context.drawImage(game.currentLevel.foregroundImage,game.offsetLeft,0,640,480,0,0,640,480);game.context.drawImage(game.slingshotImage,game.slingshotX-game.offsetLeft,game.slingshotY);if(game.mode=="firing"){game.drawSlingshotBand()}game.context.drawImage(game.slingshotFrontImage,game.slingshotX-game.offsetLeft,game.slingshotY);game.drawAllBodies();if(!game.ended){game.animationFrame=window.requestAnimationFrame(game.animate,game.canvas)}},drawAllBodies:function(){for(var e=box2d.world.GetBodyList();e;e=e.GetNext()){var t=e.GetUserData();if(t){var n=e.GetPosition().x*box2d.scale;if(n<0||n>game.currentLevel.foregroundImage.width||t.health&&t.health<0){box2d.world.DestroyBody(e);if(t.type=="villain"){game.score+=t.points;$("#score").html("Score: "+game.score)}if(t.breakSound){t.breakSound.play()}}else{entities.draw(t,e.GetPosition(),e.GetAngle())}}}},mouseOnCurrentHero:function(){if(!game.currentHero){return false}var e=game.currentHero.GetPosition();var t=Math.pow(e.x*box2d.scale-mouse.x-game.offsetLeft,2)+Math.pow(e.y*box2d.scale-mouse.y,2);var n=Math.pow(game.currentHero.GetUserData().radius,2);return t<=n},showEndingScreen:function(){game.stop();if(game.mode=="level-success"){$("#endingmessage").html("Mouai, pas mal");$("#playnextlevel").show();if(game.currentLevel.number==levels.data.length-1){$("#playnextlevel").hide()}}else{$("#endingmessage").html("Tu sers a rien !!!");$("#playnextlevel").hide()}$("#endingscreen").show()},drawSlingshotBand:function(){game.context.strokeStyle="rgb(68,31,11)";game.context.lineWidth=6;var e=game.currentHero.GetUserData().radius;var t=game.currentHero.GetPosition().x*box2d.scale;var n=game.currentHero.GetPosition().y*box2d.scale;var r=Math.atan2(game.slingshotY+25-n,game.slingshotX+50-t);var i=t-e*Math.cos(r);var s=n-e*Math.sin(r);game.context.beginPath();game.context.moveTo(game.slingshotX+50-game.offsetLeft,game.slingshotY+25);game.context.lineTo(t-game.offsetLeft,n);game.context.stroke();entities.draw(game.currentHero.GetUserData(),game.currentHero.GetPosition(),game.currentHero.GetAngle());game.context.beginPath();game.context.moveTo(i-game.offsetLeft,s);game.context.lineTo(game.slingshotX-game.offsetLeft+10,game.slingshotY+30);game.context.stroke()},restartLevel:function(){window.cancelAnimationFrame(game.animationFrame);game.lastUpdateTime=undefined;levels.load(game.currentLevel.number)},startNextLevel:function(){window.cancelAnimationFrame(game.animationFrame);game.lastUpdateTime=undefined;levels.load(game.currentLevel.number+1)},startBackgroundMusic:function(){var e=$("#togglemusic")[0];game.backgroundMusic.play();e.src="images/icons/sound.png"},stopBackgroundMusic:function(){var e=$("#togglemusic")[0];e.src="images/icons/nosound.png";game.backgroundMusic.pause();game.backgroundMusic.currentTime=0},toggleBackgroundMusic:function(){var e=$("#togglemusic")[0];if(game.backgroundMusic.paused){game.backgroundMusic.play();e.src="images/icons/sound.png"}else{game.backgroundMusic.pause();$("#togglemusic")[0].src="images/icons/nosound.png"}},stop:function(){if(game.animationFrame){window.cancelAnimationFrame(game.animationFrame);game.stopBackgroundMusic();game.currentHero=undefined}}};var loader={loaded:true,loadedCount:0,totalCount:0,init:function(){var e,t;var n=document.createElement("audio");if(n.canPlayType){e=""!=n.canPlayType("audio/mpeg");t=""!=n.canPlayType('audio/ogg; codes="vorbis"')}else{e=false;t=false}loader.soundFileExtn=t?".ogg":e?".mp3":undefined},loadImage:function(e){this.totalCount++;this.loaded=false;$("#loadingscreen").show();var t=new Image;t.src=e;t.onload=loader.itemLoaded;return t},soundFileExtn:".ogg",loadSound:function(e){this.totalCount++;this.loaded=false;$("#loadingscreen").show();var t=new Audio;t.src=e+loader.soundFileExtn;t.addEventListener("canplaythrough",loader.itemLoaded,false);return t},itemLoaded:function(){loader.loadedCount++;$("#loadingmessage").html("Loaded "+loader.loadedCount+" of "+loader.totalCount);if(loader.loadedCount>=loader.totalCount){loader.loaded=true;$("#loadingscreen").hide();loader.loadedCount=0;loader.totalCount=0;if(loader.onload){loader.onload();loader.onload=undefined}}}};var mouse={x:0,y:0,down:false,init:function(){$("#gamecanvas").mousemove(mouse.mousemovehandler);$("#gamecanvas").mousedown(mouse.mousedownhandler);$("#gamecanvas").mouseup(mouse.mouseuphandler);$("#gamecanvas").mouseout(mouse.mouseuphandler);$("#gamecanvas").on("vmousemove",mouse.mousemovehandler);$("#gamecanvas").on("vmousedown",mouse.mousedownhandler);$("#gamecanvas").on("vmouseup",mouse.mouseuphandler);$("#gamecanvas").on("vmouseout",mouse.mouseuphandler)},mousemovehandler:function(e){var t=$("#gamecanvas").offset();mouse.x=e.pageX-t.left;mouse.y=e.pageY-t.top;if(mouse.down)mouse.dragging=true},mousedownhandler:function(e){mouse.down=true;mouse.downX=mouse.x;mouse.downY=mouse.y;e.originalEvent.preventDefault()},mouseuphandler:function(e){mouse.down=false;mouse.dragging=false}};var entities={definitions:{glass:{fullHealth:150,density:2.4,friction:.4,restitution:.15},wood:{fullHealth:750,density:.7,friction:.7,restitution:.4},dirt:{density:3,friction:1.5,restitution:.2},burger:{shape:"circle",fullHealth:40,radius:25,density:1,friction:.5,restitution:.4},sodacan:{shape:"rectangle",fullHealth:80,width:40,height:60,density:1,friction:.5,restitution:.7},fries:{shape:"rectangle",fullHealth:50,width:40,height:50,density:1,friction:.5,restitution:.6},apple:{shape:"circle",radius:25,density:1.5,friction:.5,restitution:.4},orange:{shape:"circle",radius:25,density:1.5,friction:.5,restitution:.4},strawberry:{shape:"circle",radius:15,density:.2,friction:.5,restitution:.4},angry_roux:{shape:"circle",radius:30,density:.6,friction:.5,restitution:.5},poney1:{shape:"rectangle",fullHealth:100,width:70,height:60,density:.85,friction:.5,restitution:.6},poney2:{shape:"rectangle",fullHealth:100,width:81,height:50,density:.85,friction:.5,restitution:.6},poney3:{shape:"rectangle",fullHealth:100,width:56,height:70,density:.85,friction:.5,restitution:.6}},create:function(e){var t=entities.definitions[e.name];if(!t){console.log("Undefined entity name",e.name);return}switch(e.type){case"block":e.health=t.fullHealth;e.fullHealth=t.fullHealth;e.shape="rectangle";e.sprite=loader.loadImage("images/entities/"+e.name+".png");e.breakSound=game.breakSound[e.name];box2d.createRectangle(e,t);break;case"ground":e.shape="rectangle";box2d.createRectangle(e,t);break;case"hero":case"villain":e.health=t.fullHealth;e.fullHealth=t.fullHealth;e.sprite=loader.loadImage("images/entities/"+e.name+".png");e.shape=t.shape;e.bounceSound=game.bounceSound;if(t.shape=="circle"){e.radius=t.radius;box2d.createCircle(e,t)}else if(t.shape=="rectangle"){e.width=t.width;e.height=t.height;box2d.createRectangle(e,t)}break;default:console.log("Undefined entity type",e.type);break}},draw:function(e,t,n){game.context.translate(t.x*box2d.scale-game.offsetLeft,t.y*box2d.scale);game.context.rotate(n);switch(e.type){case"block":game.context.drawImage(e.sprite,0,0,e.sprite.width,e.sprite.height,-e.width/2-1,-e.height/2-1,e.width+2,e.height+2);break;case"villain":case"hero":if(e.shape=="circle"){game.context.drawImage(e.sprite,0,0,e.sprite.width,e.sprite.height,-e.radius-1,-e.radius-1,e.radius*2+2,e.radius*2+2)}else if(e.shape=="rectangle"){game.context.drawImage(e.sprite,0,0,e.sprite.width,e.sprite.height,-e.width/2-1,-e.height/2-1,e.width+2,e.height+2)}break;case"ground":break}game.context.rotate(-n);game.context.translate(-t.x*box2d.scale+game.offsetLeft,-t.y*box2d.scale)}};var levels={data:[{foreground:"desert-foreground",background:"clouds-background",entities:[{type:"ground",name:"dirt",x:500,y:440,width:1e3,height:20,isStatic:true},{type:"ground",name:"wood",x:180,y:390,width:40,height:80,isStatic:true},{type:"block",name:"wood",x:520,y:375,angle:90,width:100,height:25},{type:"block",name:"glass",x:520,y:275,angle:90,width:100,height:25},{type:"villain",name:"poney3",x:520,y:200,points:590},{type:"block",name:"wood",x:620,y:375,angle:90,width:100,height:25},{type:"block",name:"glass",x:620,y:275,angle:90,width:100,height:25},{type:"villain",name:"poney1",x:620,y:200,points:420},{type:"hero",name:"angry_roux",x:90,y:410},{type:"hero",name:"angry_roux",x:170,y:410}]},{foreground:"desert-foreground",background:"clouds-background",entities:[{type:"ground",name:"dirt",x:500,y:425,width:1e3,height:20,isStatic:true},{type:"ground",name:"wood",x:180,y:390,width:30,height:80,isStatic:true},{type:"block",name:"wood",x:815,y:380,angle:90,width:100,height:25},{type:"block",name:"wood",x:720,y:380,angle:90,width:100,height:25},{type:"block",name:"wood",x:625,y:380,angle:90,width:100,height:25},{type:"block",name:"glass",x:670,y:280,width:100,height:25},{type:"block",name:"glass",x:770,y:280,width:100,height:25},{type:"block",name:"glass",x:670,y:255,angle:90,width:100,height:25},{type:"block",name:"glass",x:770,y:255,angle:90,width:100,height:25},{type:"block",name:"wood",x:720,y:155,width:100,height:25},{type:"villain",name:"poney1",x:720,y:260,points:590},{type:"villain",name:"poney2",x:670,y:405,points:420},{type:"villain",name:"poney3",x:765,y:395,points:150},{type:"hero",name:"angry_roux",x:80,y:415},{type:"hero",name:"angry_roux",x:120,y:405},{type:"hero",name:"angry_roux",x:200,y:402}]},{foreground:"desert-foreground",background:"clouds-background",entities:[{type:"ground",name:"dirt",x:500,y:425,width:1e3,height:20,isStatic:true},{type:"ground",name:"wood",x:180,y:390,width:30,height:80,isStatic:true},{type:"villain",name:"poney1",x:405,y:390,points:500},{type:"block",name:"wood",x:435,y:380,angle:90,width:100,height:25},{type:"block",name:"wood",x:600,y:380,angle:90,width:100,height:25},{type:"block",name:"glass",x:600,y:280,angle:90,width:100,height:25},{type:"block",name:"wood",x:625,y:380,angle:90,width:100,height:25},{type:"block",name:"wood",x:715,y:380,angle:90,width:100,height:25},{type:"block",name:"glass",x:665,y:280,width:100,height:25},{type:"block",name:"glass",x:665,y:255,width:100,height:25},{type:"villain",name:"poney3",x:665,y:230,points:750},{type:"villain",name:"poney2",x:655,y:380,points:1e3},{type:"block",name:"wood",x:740,y:380,angle:90,width:100,height:25},{type:"block",name:"glass",x:733,y:280,angle:90,width:100,height:25},{type:"hero",name:"angry_roux",x:80,y:415},{type:"hero",name:"angry_roux",x:120,y:405},{type:"hero",name:"angry_roux",x:200,y:402}]},{foreground:"desert-foreground",background:"clouds-background",entities:[{type:"ground",name:"dirt",x:500,y:425,width:1e3,height:20,isStatic:true},{type:"ground",name:"wood",x:180,y:390,width:30,height:80,isStatic:true},{type:"block",name:"wood",x:500,y:380,width:100,height:25},{type:"block",name:"wood",x:500,y:355,width:100,height:25},{type:"block",name:"wood",x:500,y:330,width:100,height:25},{type:"block",name:"wood",x:500,y:305,width:100,height:25},{type:"block",name:"wood",x:500,y:280,width:100,height:25},{type:"block",name:"wood",x:500,y:255,width:100,height:25},{type:"block",name:"wood",x:500,y:230,width:100,height:25},{type:"block",name:"wood",x:500,y:205,width:100,height:25},{type:"block",name:"wood",x:500,y:180,width:100,height:25},{type:"villain",name:"poney2",x:505,y:155,points:350},{type:"villain",name:"poney3",x:605,y:380,points:500},{type:"block",name:"wood",x:700,y:380,width:100,height:25},{type:"block",name:"wood",x:700,y:355,width:100,height:25},{type:"block",name:"wood",x:700,y:330,width:100,height:25},{type:"villain",name:"poney1",x:705,y:305,points:500},{type:"hero",name:"angry_roux",x:80,y:415},{type:"hero",name:"angry_roux",x:120,y:405},{type:"hero",name:"angry_roux",x:200,y:402}]}],init:function(){var e="";for(var t=0;t<levels.data.length;t++){var n=levels.data[t];e+='<input type="button" value="'+(t+1)+'">'}$("#levelselectscreen").html(e);$("#levelselectscreen input").click(function(){levels.load(this.value-1);$("#levelselectscreen").hide()})},load:function(e){box2d.init();game.currentLevel={number:e,hero:[]};game.score=0;$("#score").html("Score: "+game.score);var t=levels.data[e];game.currentLevel.backgroundImage=loader.loadImage("images/backgrounds/"+t.background+".png");game.currentLevel.foregroundImage=loader.loadImage("images/backgrounds/"+t.foreground+".png");game.slingshotImage=loader.loadImage("images/slingshot.png");game.slingshotFrontImage=loader.loadImage("images/slingshot-front.png");for(var n=t.entities.length-1;n>=0;n--){var r=t.entities[n];entities.create(r)}if(loader.loaded){game.start()}else{loader.onload=game.start}}}
